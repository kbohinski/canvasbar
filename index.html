<html>
<head>
    <link rel="stylesheet"
          href="https://du11hjcvx0uqb.cloudfront.net/dist/brandable_css/289606ed00d3518a0ed0dc2afd44d6f0/new_styles_normal_contrast/bundles/common-bc0cf2950d.css"/>
    <link rel="stylesheet"
          href="https://du11hjcvx0uqb.cloudfront.net/dist/brandable_css/289606ed00d3518a0ed0dc2afd44d6f0/new_styles_normal_contrast/bundles/dashboard-c42271f6c4.css"/>
    <link rel="stylesheet"
          href="https://du11hjcvx0uqb.cloudfront.net/dist/brandable_css/289606ed00d3518a0ed0dc2afd44d6f0/new_styles_normal_contrast/bundles/dashboard_card-ef8fe1913e.css"/>
    <link rel="stylesheet"
          href="https://instructure-uploads.s3.amazonaws.com/account_190000000088968/attachments/71158649/new_ui_override.css?AWSAccessKeyId=AKIAJFNFXH2V2O7RPCAA&Expires=1945583226&Signature=CWzLFjL0BA2oRCgkWNfKoQSeVJ8%3D&response-cache-control=Cache-Control%3Amax-age%3D473364000.0%2C%20public&response-expires=473364000.0"/>
    <link rel="stylesheet"
          href="https://du11hjcvx0uqb.cloudfront.net/dist/brandable_css/289606ed00d3518a0ed0dc2afd44d6f0/new_styles_normal_contrast/bundles/common-bc0cf2950d.css"/>
    <link rel="stylesheet"
          href="https://du11hjcvx0uqb.cloudfront.net/dist/brandable_css/no_variables/jst/tinymce/InsertUpdateImageView-576a8e7d68.css"/>
    <link rel="stylesheet"
          href="https://du11hjcvx0uqb.cloudfront.net/dist/brandable_css/289606ed00d3518a0ed0dc2afd44d6f0/new_styles_normal_contrast/jst/TreeBrowser-4d31810d2d.css"/>
    <link rel="stylesheet"
          href="https://du11hjcvx0uqb.cloudfront.net/dist/brandable_css/289606ed00d3518a0ed0dc2afd44d6f0/new_styles_normal_contrast/jst/FindFlickrImageView-3605dd74b1.css"/>

    <link rel="stylesheet" href="InstructureIcons-Line.css"/>
</head>
<body>
<div id="body" style="margin: .5em;">
    <h3>Please enter your school's canvas url:</h3>
    <p><i>TCNJ's is provided as an example...</i></p>
    <form>
        <input id="url" type="text" value="tcnj.instructure.com">
        <br>
        <button id="login-submit">Submit</button>
    </form>
    <br>
    <h4 style="visibility: hidden;" id="loading">Thanks, loading Canvas...</h4>
</div>
</body>
<script>
  let shell = require('electron').shell
  const openExternal = (url) => {
    shell.openExternal(url)
  }
  let ipc = require('electron').ipcRenderer
  let body = document.getElementById('body')
  let baseUrl = ''

  const loadCanvas = (url) => {
    let xhr = new XMLHttpRequest()
    xhr.open('GET', url, true)
    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 400) {
        //let page = r.split('<body>')[1].split('</body>')[0]
        body.innerHTML = getDOM(xhr.response)
        fixLinks()
      }
    }
    xhr.send()
  }

  ipc.on('loadPage', (e, data) => {
    console.log('client -- got page info')
    ipc.send('log', 'client -- got page info')
    baseUrl = data.split('dashboard-sidebar')[0]
    loadCanvas(data)
  })

  document.getElementById('login-submit').addEventListener('click', (e) => {
    e.preventDefault()
    const school = document.getElementById('url').value
    const toLoad = 'https://' + school.trim() + '/dashboard-sidebar'
    baseUrl = 'https://' + school.trim() + '/'
    ipc.send('schoolUrl', toLoad)
    document.getElementById('loading').style.visibility = 'visible'
    loadCanvas(toLoad)
  })

  if (window.location.href.split('#')[1] !== '') {
    baseUrl = window.location.href.split('#')[1].split('dashboard-sidebar')[0]
    loadCanvas(window.location.href.split('#')[1])
  }

  function getDOM (content) {
    return '<aside id="right-side" role="complementary" style="opacity: 1; display: block;">' + content + '</aside>'
  }

  function fixLinks () {
    let links = document.getElementsByTagName('a')
    for (let i = 0; i < links.length; i++) {
      links[i].addEventListener('click', (e) => {
        console.log('clicked!', e.target)
        e.preventDefault()
        openExternal(baseUrl + e.target.href.split('file://')[1]);
      })
      links[i].href = '#'
    }
  }
</script>
</html>